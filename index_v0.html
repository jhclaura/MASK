<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>cam feed_test01</title>
		<link rel="stylesheet" type="text/css" href="css/style.css">
	</head>
	<body>		
			<script type="text/javascript" src="js/lib/three.min_69.js"></script>
			<script src="//code.jquery.com/jquery-1.11.2.min.js"></script>

			<div id="render-canvas"></div>

			<div class="select">
				<label for="videoSource">Video source: </label><select id="videoSource"></select>
			</div>

			<!-- cam -->
			<p id="errorMessage" style="display:none"></p>
			<video id="monitor" autoplay loop width="240" height="180" style="display:none"></video>
			<video id="monitor" autoplay loop style="display:none"></video>
			<canvas id="videoImage" width="240" height="180" style="display:none"></canvas>


			<script type="text/javascript">
				var videoElement = document.querySelector('video');
				var videoSelect = document.querySelector('select#videoSource');

				navigator.getUserMedia = navigator.getUserMedia || 
					navigator.webkitGetUserMedia || navigator.mozGetUserMedia;

				// ref: https://github.com/samdutton/simpl/blob/master/getusermedia/sources/js/main.js
				var audioSource = null, videoSource = null, camUserID = null, camEnvironmentID = null;
				var mediaConstraints = {};

				function gotSources(sourceInfos) {
				  for (var i = 0; i !== sourceInfos.length; ++i) {
				    var sourceInfo = sourceInfos[i];
				    var option = document.createElement('option');
				    option.value = sourceInfo.id;
				   	if (sourceInfo.kind === 'video') {
				   		// console.log(sourceInfo);

				   		if (sourceInfo.facing === 'user') camUserID = sourceInfo.id;
				   		else if (sourceInfo.facing === 'environment') {

				   			camEnvironmentID = sourceInfo.id;
				   			mediaConstraints = {
								video: {
									optional: [{sourceId: camEnvironmentID}]
								}
							};
							navigator.getUserMedia(mediaConstraints, successCallback, errorCallback);
				   		}
				   		else {
				   			camEnvironmentID = sourceInfo.id;
				   			mediaConstraints = {
								video: {
									optional: [{sourceId: camEnvironmentID}]
								}
							};
							navigator.getUserMedia(mediaConstraints, successCallback, errorCallback);
				   		}

				      option.text = sourceInfo.label || 'camera ' + (videoSelect.length + 1);
				      videoSelect.appendChild(option);
				    } 
				    // else {
				    //   console.log('Some other kind of source: ', sourceInfo);
				    // }
				  }
				}

				/*
				function gotSources(sourceInfos) {

				  for (var i = 0; i != sourceInfos.length; ++i) {
				    var sourceInfo = sourceInfos[i];
				    // var option = document.createElement('option');
				    // option.value = sourceInfo.id;

				    // console.log( sourceInfo );

				    // if (sourceInfo.kind == 'audio') {
				    //  	console.log( sourceInfo.id, sourceInfo.label || 'microphone' );
				    // }
				    
				    if (sourceInfo.kind == 'video') {
				    	// console.log( sourceInfo.id, sourceInfo.label || 'video' );
					    if (sourceInfo.facing === 'user') {
					    	camUserID = sourceInfo.id;
					    	console.log('assign cam user');
					    }
					    if (sourceInfo.facing === 'environment') {
					    	camEnvironmentID = sourceInfo.id;
					    	console.log('assign cam environment');
					    }
					}
				    // if (sourceInfo.kind === 'audio') {
				    //   option.text = sourceInfo.label || 'microphone ' + (audioSelect.length + 1);
				    //   audioSelect.appendChild(option);
				    // } else if (sourceInfo.kind === 'video') {
				    //   option.text = sourceInfo.label || 'camera ' + (videoSelect.length + 1);
				    //   videoSelect.appendChild(option);
				    // } else {
				    //   console.log('Some other kind of source: ', sourceInfo);
				    // }
				  }
				}
				*/

				if (typeof MediaStreamTrack.getSources === 'undefined'){
				  alert('This browser does not support MediaStreamTrack.\n\nTry Chrome Canary.');
				} else {
				  MediaStreamTrack.getSources(gotSources);
				}

				

				/*
				var camvideo = document.getElementById('monitor');
				if (!navigator.getUserMedia) 
				{
					document.getElementById('errorMessage').innerHTML = 
						'Sorry. <code>navigator.getUserMedia()</code> is not available.';
				} else {
					// navigator.getUserMedia({video: true}, gotStream, noStream);

					var constraints = {
						video: {
							optional: [{sourceId: camEnvironmentID}]
						}
					};
					navigator.getUserMedia( constraints, gotStream, noStream );
				}
				*/


				function gotStream(stream) 
				{
					if (window.URL) 
					{   camvideo.src = window.URL.createObjectURL(stream);   } 
					else // Opera
					{   camvideo.src = stream;   }

					camvideo.onerror = function(e) 
					{   stream.stop();   };

					stream.onended = noStream;
				}

				function noStream(e) 
				{
					var msg = 'No camera available.';
					if (e.code == 1) 
					{   msg = 'User denied access to use camera.';   }
					document.getElementById('errorMessage').textContent = msg;
				}

				function successCallback(stream) {
				  window.stream = stream; // make stream available to console
				  videoElement.src = window.URL.createObjectURL(stream);
				  videoElement.play();
				}

				function errorCallback(error){
				  console.log('navigator.getUserMedia error: ', error);
				}

				function start(){
				  if (!!window.stream) {
				    videoElement.src = null;
				    window.stream.stop();
				  }
				  var videoSource = videoSelect.value;
				  console.log(videoSource);

				  mediaConstraints = {
				    video: {
				      optional: [{sourceId: videoSource}]
				    }
				  };
				  // console.log(videoSource);

				  navigator.getUserMedia(mediaConstraints, successCallback, errorCallback);
				}

				videoSelect.onchange = start;

				// start();
			</script>


			<!-- Default version
			<script type="text/javascript">
				navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia;
				window.URL = window.URL || window.webkitURL;

				var camvideo = document.getElementById('monitor');

					if (!navigator.getUserMedia) 
					{
						document.getElementById('errorMessage').innerHTML = 
							'Sorry. <code>navigator.getUserMedia()</code> is not available.';
					} else {
						navigator.getUserMedia({video: true}, gotStream, noStream);
					}

				function gotStream(stream) 
				{
					if (window.URL) 
					{   camvideo.src = window.URL.createObjectURL(stream);   } 
					else // Opera
					{   camvideo.src = stream;   }

					camvideo.onerror = function(e) 
					{   stream.stop();   };

					stream.onended = noStream;
				}

				function noStream(e) 
				{
					var msg = 'No camera available.';
					if (e.code == 1) 
					{   msg = 'User denied access to use camera.';   }
					document.getElementById('errorMessage').textContent = msg;
				}
			</script>
			-->

			<!-- indie -->
			<!-- <div id="blocker" style="display: -webkit-box;">
				<div id="instructions" >
					<img width="60" height="60" src="images/click.gif">
				</div>
			</div> -->

			<script type="text/javascript" src="js/controls/PointerLockControls.js"></script>
			<script src="js/StereoEffect.js"></script>
  			<script src="js/controls/DeviceControls_vC3.js"></script>
			<script type="text/javascript" src="js/Detector.js"></script>
			<script type="text/javascript" src="js/KeyboardState.js"></script>
			<script type="text/javascript" src="js/lib/tween.min.js"></script>
			<script type="text/javascript" src="js/stats.min.js"></script>
			<script type="text/javascript" src="js/wave.js"></script>
			<script type="text/javascript" src="js/script_cam_v2.js"></script>
	</body>
</html>
